<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Agent Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>LinkedIn Agent Dashboard</h1>
        </header>
        <main>
            <section id="status">
                <h2>Sistem Durumu</h2>
                <p>Durum: <span id="system-status">Aktif</span></p>
                <p>Son Çalışma: <span id="last-run">Çalışıyor...</span></p>
            </section>
            <section id="settings">
                <h2>Ayarlar</h2>
                <form>
                    <label for="keywords">Takip Edilecek Anahtar Kelimeler:</label>
                    <input type="text" id="keywords" name="keywords" value="AI, python, data science">
                    <button type="submit">Kaydet</button>
                </form>
            </section>

            <section id="scheduled-jobs">
                <h2>Planlanmış Görevler</h2>
                <ul id="jobs-list">
                    <li>Yükleniyor...</li>
                </ul>
            </section>

            <section id="manual-controls">
                <h2>Manuel Kontrol Paneli</h2>
                <div class="controls-container">
                    <button onclick="triggerAction('/api/trigger/post')">Anlık Paylaşım Yap</button>
                    <button onclick="triggerAction('/api/trigger/comment')">Anlık Yorum Yap</button>
                    <button onclick="triggerAction('/api/trigger/invite')">Anlık Davet Gönder</button>
                </div>
                <p id="manual-action-status"></p>
            </section>

            <section id="auth-instructions">
                <h2>Kimlik Doğrulama (Authentication)</h2>
                <p>Eğer "Eylem Akışı"nda 'CHALLENGE' hatası alırsanız, bu LinkedIn'in güvenlik doğrulaması istediği anlamına gelir. Oturumu yenilemek için:</p>
                <ol>
                    <li>Codespace'te <strong>yeni bir terminal sekmesi</strong> açın.</li>
                    <li>Aşağıdaki komutu kopyalayıp o yeni terminale yapıştırın ve <strong>Enter</strong>'a basın:</li>
                </ol>
                <code>python3 interactive_login.py</code>
                <p>Terminaldeki adımları takip ederek doğrulamayı tamamladıktan sonra, bu sayfayı yenileyip manuel kontrolleri tekrar kullanabilirsiniz.</p>
            </section>

            <section id="activity-feed">
                <h2>Eylem Akışı</h2>
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-item">
                        <p><strong>Tür:</strong> {{ log.action_type }}</p>
                        <p><strong>Detay:</strong> {{ log.details }}
                            {% if log.result_url %}
                                <a href="{{ log.result_url }}" target="_blank" class="verify-link">(Sonucu Gör)</a>
                            {% endif %}
                        </p>
                        <p><strong>Zaman:</strong> {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>Henüz gerçekleştirilmiş bir eylem bulunmuyor.</p>
                {% endif %}
            </section>
        </main>
    </div>

    <script>
        async function fetchScheduledJobs() {
            try {
                const response = await fetch('/api/scheduled-jobs');
                const jobs = await response.json();
                const jobsList = document.getElementById('jobs-list');
                jobsList.innerHTML = '';

                if (jobs.length === 0) {
                    jobsList.innerHTML = '<li>Aktif planlanmış görev bulunmuyor.</li>';
                    return;
                }

                jobs.forEach(job => {
                    const listItem = document.createElement('li');
                    const nextRun = new Date(job.next_run_time).toLocaleString('tr-TR');
                    listItem.textContent = `Görev: ${job.id} - Sonraki Çalışma: ${nextRun}`;
                    jobsList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching scheduled jobs:', error);
                document.getElementById('jobs-list').innerHTML = '<li>Görevler yüklenirken bir hata oluştu.</li>';
            }
        }

        async function triggerAction(endpoint, skipReload = false) {
            const statusElement = document.getElementById('manual-action-status');
            statusElement.textContent = 'İşlem başlatılıyor...';
            statusElement.style.color = '#1877f2';

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();

                statusElement.textContent = result.message || 'İşlem başarıyla tetiklendi!';
                statusElement.style.color = 'green';

                if (!skipReload) {
                    setTimeout(() => location.reload(), 1500);
                }

            } catch (error) {
                console.error(`Error triggering action ${endpoint}:`, error);
                statusElement.textContent = `İşlem sırasında bir hata oluştu: ${error.message}`;
                statusElement.style.color = 'red';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchScheduledJobs();
            setInterval(fetchScheduledJobs, 10000);
        });
    </script>
</body>
</html>
