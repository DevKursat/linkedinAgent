<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Agent Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>LinkedIn Agent Dashboard</h1>
        </header>
        <main>
            <section id="status">
                <h2>Sistem Durumu</h2>
                <p>Durum: <span id="system-status">Aktif</span></p>
                <p>Son Ã‡alÄ±ÅŸma: <span id="last-run">2025-10-27 21:45:00</span></p>
            </section>
            <section id="settings">
                <h2>Ayarlar</h2>
                <form>
                    <label for="keywords">Takip Edilecek Anahtar Kelimeler:</label>
                    <input type="text" id="keywords" name="keywords" value="AI, python, data science">
                    <button type="submit">Kaydet</button>
                </form>
            </section>

            <section id="scheduled-jobs">
                <h2>PlanlanmÄ±ÅŸ GÃ¶revler</h2>
                <ul id="jobs-list">
                    <li>YÃ¼kleniyor...</li>
                </ul>
            </section>

            <section id="manual-controls">
                <h2>Otomatik Ä°ÅŸlemler</h2>
                <p style="color: #28a745; font-size: 0.95em; margin-bottom: 15px;">
                    ğŸ¤– <strong>Otomatik KeÅŸif Aktif:</strong> Sistem ilgi alanlarÄ±nÄ±za gÃ¶re postlarÄ± ve profilleri otomatik buluyor
                </p>
                <div class="controls-container">
                    <button onclick="triggerAction('/api/trigger/post')">AnlÄ±k PaylaÅŸÄ±m Yap</button>
                    <button onclick="triggerAction('/api/trigger/comment')">Otomatik Yorum Yap</button>
                    <button onclick="triggerAction('/api/trigger/invite')">Otomatik Davet GÃ¶nder</button>
                </div>
                <p id="manual-action-status"></p>
            </section>

            <section id="translate-post-section">
                <h2>Ã‡evir ve PaylaÅŸ</h2>
                <p style="color: #666; font-size: 0.9em;">
                    â„¹ï¸ Ã‡evirip paylaÅŸmak istediÄŸiniz LinkedIn gÃ¶nderisinin URL'sini aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±rÄ±n.
                </p>
                <div style="margin-top: 15px;">
                    <input type="text" id="translate-url-input" placeholder="LinkedIn post URL'sini buraya yapÄ±ÅŸtÄ±rÄ±n..."
                           style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="submitForTranslation()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Ã‡eviri Ä°Ã§in GÃ¶nder
                    </button>
                </div>
                <p id="translate-status" style="margin-top: 10px;"></p>
            </section>

            <section id="approval-section">
                <h2>Onay Bekleyen Ã‡eviriler</h2>
                {% if pending_posts %}
                    {% for post in pending_posts %}
                    <div class="approval-card">
                        <div class="post-content">
                            <div class="original-post">
                                <h3>Orijinal GÃ¶nderi</h3>
                                <p>{{ post.original_content }}</p>
                            </div>
                            <div class="translated-post">
                                <h3>Ã‡evrilen GÃ¶nderi</h3>
                                <p>{{ post.translated_content }}</p>
                            </div>
                        </div>
                        <div class="approval-actions">
                            <button onclick="approvePost({{ post.id }})">Onayla ve PaylaÅŸ</button>
                            <button onclick="rejectPost({{ post.id }})" class="reject">Reddet</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>Onay bekleyen Ã§eviri bulunmuyor.</p>
                {% endif %}
            </section>

            <section id="manual-comment-section">
                <h2>Manuel Yorum (Ä°steÄŸe BaÄŸlÄ±)</h2>
                <p style="color: #666; font-size: 0.9em;">
                    â„¹ï¸ Belirli bir gÃ¶nderiye manuel yorum yapmak isterseniz buradan yapabilirsiniz. Otomatik yorum iÃ§in yukarÄ±daki butonu kullanÄ±n.
                </p>
                <div style="margin-top: 15px;">
                    <input type="text" id="post-url-input" placeholder="LinkedIn post URL'sini buraya yapÄ±ÅŸtÄ±rÄ±n..." 
                           style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <textarea id="custom-comment-input" placeholder="Ä°steÄŸe baÄŸlÄ±: Ã–zel yorum metni (boÅŸ bÄ±rakÄ±rsanÄ±z AI oluÅŸturur)" 
                              style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                    <button onclick="submitManualComment()" style="padding: 10px 20px; background: #0073b1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Yorum GÃ¶nder
                    </button>
                </div>
                <p id="manual-comment-status" style="margin-top: 10px;"></p>
            </section>

            <section id="auth-controls">
                <h2>Kimlik DoÄŸrulama</h2>
                {% if is_logged_in %}
                    <p>LinkedIn hesabÄ±nÄ±zla baÅŸarÄ±yla giriÅŸ yapÄ±ldÄ±.</p>
                    <p><a href="/logout">Ã‡Ä±kÄ±ÅŸ Yap</a></p>
                {% else %}
                    <p>Botun Ã§alÄ±ÅŸabilmesi iÃ§in LinkedIn hesabÄ±nÄ±zla oturum aÃ§manÄ±z gerekmektedir.</p>
                    <a href="/login" class="button">LinkedIn ile GiriÅŸ Yap</a>
                {% endif %}
            </section>

            <section id="activity-feed">
                <h2>Eylem AkÄ±ÅŸÄ±</h2>
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-item">
                        <p><strong>TÃ¼r:</strong> {{ log.action_type }}</p>
                        <p><strong>Detay:</strong> {{ log.details }}
                            {% if log.result_url %}
                                <a href="{{ log.result_url }}" target="_blank" class="verify-link">(Sonucu GÃ¶r)</a>
                            {% endif %}
                        </p>
                        <p><strong>Zaman:</strong> {{ log.timestamp | istanbul_time }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>HenÃ¼z gerÃ§ekleÅŸtirilmiÅŸ bir eylem bulunmuyor.</p>
                {% endif %}
            </section>
        </main>
    </div>

    <script>
        // Fetch and display scheduled jobs
        async function fetchScheduledJobs() {
            try {
                const response = await fetch('/api/scheduled-jobs');
                const jobs = await response.json();
                const jobsList = document.getElementById('jobs-list');
                jobsList.innerHTML = ''; // Clear current list

                if (jobs.length === 0) {
                    jobsList.innerHTML = '<li>Aktif planlanmÄ±ÅŸ gÃ¶rev bulunmuyor.</li>';
                    return;
                }

                jobs.forEach(job => {
                    const listItem = document.createElement('li');
                    const nextRun = new Date(job.next_run_time).toLocaleString('tr-TR');
                    listItem.textContent = `GÃ¶rev: ${job.id} - Sonraki Ã‡alÄ±ÅŸma: ${nextRun}`;
                    jobsList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching scheduled jobs:', error);
                document.getElementById('jobs-list').innerHTML = '<li>GÃ¶revler yÃ¼klenirken bir hata oluÅŸtu.</li>';
            }
        }

        // Trigger a manual action
        async function triggerAction(endpoint, skipReload = false) {
            const statusElement = document.getElementById('manual-action-status');
            statusElement.innerHTML = '<p style="color: #1877f2;">Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...</p>';

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    let html = `<div style="color: green; margin-top: 10px;">
                        <p><strong>âœ… ${result.message}</strong></p>`;
                    
                    if (result.url) {
                        html += `<p>ğŸ”— <a href="${result.url}" target="_blank" style="color: #0073b1; text-decoration: underline;">LinkedIn'de GÃ¶rÃ¼ntÃ¼le</a></p>`;
                    }
                    
                    if (result.actions && result.actions.length > 0) {
                        html += '<div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 3px solid #0073b1;">';
                        result.actions.forEach(action => {
                            html += `<p style="margin: 5px 0;">${action}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    statusElement.innerHTML = html;
                } else {
                    statusElement.innerHTML = `<p style="color: red;">âŒ ${result.message || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z oldu.'}</p>`;
                }

                // Refresh the activity feed after a short delay, unless skipped
                if (!skipReload && result.success) {
                    setTimeout(() => location.reload(), 3000);
                }

            } catch (error) {
                console.error(`Error triggering action ${endpoint}:`, error);
                statusElement.innerHTML = '<p style="color: red;">âŒ Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu.</p>';
            }
        }

        // Submit manual comment
        async function submitManualComment() {
            const postUrl = document.getElementById('post-url-input').value.trim();
            const customComment = document.getElementById('custom-comment-input').value.trim();
            const statusElement = document.getElementById('manual-comment-status');

            if (!postUrl) {
                statusElement.innerHTML = '<p style="color: red;">âŒ LÃ¼tfen LinkedIn post URL\'sini girin.</p>';
                return;
            }

            statusElement.innerHTML = '<p style="color: #1877f2;">Yorum gÃ¶nderiliyor...</p>';

            try {
                const response = await fetch('/api/manual_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        post_url: postUrl,
                        comment: customComment
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let html = `<div style="color: green; margin-top: 10px;">
                        <p><strong>âœ… ${result.message}</strong></p>`;
                    
                    if (result.url) {
                        html += `<p>ğŸ”— <a href="${result.url}" target="_blank" style="color: #0073b1; text-decoration: underline;">LinkedIn'de GÃ¶rÃ¼ntÃ¼le</a></p>`;
                    }
                    
                    if (result.actions && result.actions.length > 0) {
                        html += '<div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 3px solid #0073b1;">';
                        result.actions.forEach(action => {
                            html += `<p style="margin: 5px 0;">${action}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    statusElement.innerHTML = html;

                    // Clear inputs
                    document.getElementById('post-url-input').value = '';
                    document.getElementById('custom-comment-input').value = '';

                    // Refresh the activity feed after a short delay
                    setTimeout(() => location.reload(), 3000);
                } else {
                    statusElement.innerHTML = `<p style="color: red;">âŒ ${result.message || 'Yorum gÃ¶nderilemedi.'}</p>`;
                }

            } catch (error) {
                console.error('Error submitting manual comment:', error);
                statusElement.innerHTML = '<p style="color: red;">âŒ Yorum gÃ¶nderilirken bir hata oluÅŸtu.</p>';
            }
        }

        // Initial fetch and periodic refresh
        document.addEventListener('DOMContentLoaded', () => {
            fetchScheduledJobs();
            setInterval(fetchScheduledJobs, 10000); // Refresh every 10 seconds
        });

        async function submitForTranslation() {
            const postUrl = document.getElementById('translate-url-input').value.trim();
            const statusElement = document.getElementById('translate-status');

            if (!postUrl) {
                statusElement.innerHTML = '<p style="color: red;">âŒ LÃ¼tfen Ã§evrilecek gÃ¶nderinin URL\'sini girin.</p>';
                return;
            }

            statusElement.innerHTML = '<p style="color: #1877f2;">GÃ¶nderi alÄ±nÄ±yor ve Ã§eviri iÃ§in hazÄ±rlanÄ±yor...</p>';

            try {
                const response = await fetch('/api/translate-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        post_url: postUrl
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusElement.innerHTML = `<p style="color: green;"><strong>âœ… ${result.message}</strong> Onay iÃ§in ana sayfayÄ± yenileyin.</p>`;
                    // Clear input
                    document.getElementById('translate-url-input').value = '';
                    // Refresh the page to show the pending post
                    setTimeout(() => location.reload(), 2000);
                } else {
                    statusElement.innerHTML = `<p style="color: red;">âŒ ${result.message || 'Ã‡eviri isteÄŸi baÅŸarÄ±sÄ±z oldu.'}</p>`;
                }
            } catch (error) {
                console.error('Error submitting for translation:', error);
                statusElement.innerHTML = '<p style="color: red;">âŒ Ä°stek sÄ±rasÄ±nda bir hata oluÅŸtu.</p>';
            }
        }

        async function approvePost(postId) {
            await handleApprovalAction(postId, 'approve');
        }

        async function rejectPost(postId) {
            await handleApprovalAction(postId, 'reject');
        }

        async function handleApprovalAction(postId, action) {
            const statusElement = document.getElementById('approval-section'); // A general status area

            try {
                const response = await fetch(`/api/posts/${postId}/${action}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    // Refresh to show the updated list
                    location.reload();
                } else {
                    alert(`Ä°ÅŸlem baÅŸarÄ±sÄ±z: ${result.message}`);
                }
            } catch (error) {
                console.error(`Error during ${action}:`, error);
                alert('Bir hata oluÅŸtu.');
            }
        }
    </script>
</body>
</html>
