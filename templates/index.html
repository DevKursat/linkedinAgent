<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Agent Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>LinkedIn Agent Dashboard</h1>
        </header>
        <main>
            <section id="status">
                <h2>Sistem Durumu</h2>
                <p>Durum: <span id="system-status">Aktif</span></p>
                <p>Son Ã‡alÄ±ÅŸma: <span id="last-run">2025-10-27 21:45:00</span></p>
            </section>
            <section id="settings">
                <h2>Ayarlar</h2>
                <form>
                    <label for="keywords">Takip Edilecek Anahtar Kelimeler:</label>
                    <input type="text" id="keywords" name="keywords" value="AI, python, data science">
                    <button type="submit">Kaydet</button>
                </form>
            </section>

            <section id="scheduled-jobs">
                <h2>PlanlanmÄ±ÅŸ GÃ¶revler</h2>
                <ul id="jobs-list">
                    <li>YÃ¼kleniyor...</li>
                </ul>
            </section>

            <section id="manual-controls">
                <h2>Manuel Kontrol Paneli</h2>
                <div class="controls-container">
                    <button onclick="triggerAction('/api/trigger/post')">AnlÄ±k PaylaÅŸÄ±m Yap</button>
                    <button onclick="triggerAction('/api/trigger/comment')">AnlÄ±k Yorum Yap</button>
                    <button onclick="triggerAction('/api/trigger/invite')">AnlÄ±k Davet GÃ¶nder</button>
                </div>
                <p id="manual-action-status"></p>
            </section>

            <section id="auth-controls">
                <h2>Kimlik DoÄŸrulama</h2>
                {% if is_logged_in %}
                    <p>LinkedIn hesabÄ±nÄ±zla baÅŸarÄ±yla giriÅŸ yapÄ±ldÄ±.</p>
                    <p><a href="/logout">Ã‡Ä±kÄ±ÅŸ Yap</a></p>
                {% else %}
                    <p>Botun Ã§alÄ±ÅŸabilmesi iÃ§in LinkedIn hesabÄ±nÄ±zla oturum aÃ§manÄ±z gerekmektedir.</p>
                    <a href="/login" class="button">LinkedIn ile GiriÅŸ Yap</a>
                {% endif %}
            </section>

            <section id="activity-feed">
                <h2>Eylem AkÄ±ÅŸÄ±</h2>
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-item">
                        <p><strong>TÃ¼r:</strong> {{ log.action_type }}</p>
                        <p><strong>Detay:</strong> {{ log.details }}
                            {% if log.result_url %}
                                <a href="{{ log.result_url }}" target="_blank" class="verify-link">(Sonucu GÃ¶r)</a>
                            {% endif %}
                        </p>
                        <p><strong>Zaman:</strong> {{ log.timestamp | istanbul_time }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>HenÃ¼z gerÃ§ekleÅŸtirilmiÅŸ bir eylem bulunmuyor.</p>
                {% endif %}
            </section>
        </main>
    </div>

    <script>
        // Fetch and display scheduled jobs
        async function fetchScheduledJobs() {
            try {
                const response = await fetch('/api/scheduled-jobs');
                const jobs = await response.json();
                const jobsList = document.getElementById('jobs-list');
                jobsList.innerHTML = ''; // Clear current list

                if (jobs.length === 0) {
                    jobsList.innerHTML = '<li>Aktif planlanmÄ±ÅŸ gÃ¶rev bulunmuyor.</li>';
                    return;
                }

                jobs.forEach(job => {
                    const listItem = document.createElement('li');
                    const nextRun = new Date(job.next_run_time).toLocaleString('tr-TR');
                    listItem.textContent = `GÃ¶rev: ${job.id} - Sonraki Ã‡alÄ±ÅŸma: ${nextRun}`;
                    jobsList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching scheduled jobs:', error);
                document.getElementById('jobs-list').innerHTML = '<li>GÃ¶revler yÃ¼klenirken bir hata oluÅŸtu.</li>';
            }
        }

        // Trigger a manual action
        async function triggerAction(endpoint, skipReload = false) {
            const statusElement = document.getElementById('manual-action-status');
            statusElement.innerHTML = '<p style="color: #1877f2;">Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...</p>';

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    let html = `<div style="color: green; margin-top: 10px;">
                        <p><strong>âœ… ${result.message}</strong></p>`;
                    
                    if (result.url) {
                        html += `<p>ğŸ”— <a href="${result.url}" target="_blank" style="color: #0073b1; text-decoration: underline;">LinkedIn'de GÃ¶rÃ¼ntÃ¼le</a></p>`;
                    }
                    
                    if (result.actions && result.actions.length > 0) {
                        html += '<div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 3px solid #0073b1;">';
                        result.actions.forEach(action => {
                            html += `<p style="margin: 5px 0;">${action}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    statusElement.innerHTML = html;
                } else {
                    statusElement.innerHTML = `<p style="color: red;">âŒ ${result.message || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z oldu.'}</p>`;
                }

                // Refresh the activity feed after a short delay, unless skipped
                if (!skipReload && result.success) {
                    setTimeout(() => location.reload(), 3000);
                }

            } catch (error) {
                console.error(`Error triggering action ${endpoint}:`, error);
                statusElement.innerHTML = '<p style="color: red;">âŒ Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu.</p>';
            }
        }

        // Initial fetch and periodic refresh
        document.addEventListener('DOMContentLoaded', () => {
            fetchScheduledJobs();
            setInterval(fetchScheduledJobs, 10000); // Refresh every 10 seconds
        });
    </script>
</body>
</html>
