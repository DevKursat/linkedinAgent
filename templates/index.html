<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Agent Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>LinkedIn Agent Dashboard</h1>
        </header>
        <main>
            <section id="status">
                <h2>Sistem Durumu</h2>
                <p>Durum: <span id="system-status">Aktif</span></p>
                <p>Son Çalışma: <span id="last-run">2025-10-27 21:45:00</span></p>
            </section>
            <section id="settings">
                <h2>Ayarlar</h2>
                <form>
                    <label for="keywords">Takip Edilecek Anahtar Kelimeler:</label>
                    <input type="text" id="keywords" name="keywords" value="AI, python, data science">
                    <button type="submit">Kaydet</button>
                </form>
            </section>

            <section id="scheduled-jobs">
                <h2>Planlanmış Görevler</h2>
                <ul id="jobs-list">
                    <li>Yükleniyor...</li>
                </ul>
            </section>

            <section id="manual-controls">
                <h2>Manuel Kontrol Paneli</h2>
                <div class="controls-container">
                    <button onclick="triggerAction('/api/trigger/post')">Anlık Paylaşım Yap</button>
                    <button onclick="triggerAction('/api/trigger/comment')">Anlık Yorum Yap</button>
                    <button onclick="triggerAction('/api/trigger/invite')">Anlık Davet Gönder</button>
                </div>
                <p id="manual-action-status"></p>
            </section>

            <section id="manual-comment-section">
                <h2>Manuel Yorum Yap (LinkedIn Post URL ile)</h2>
                <p style="color: #666; font-size: 0.9em;">
                    ℹ️ LinkedIn arama API'si kaldırıldığı için, belirli bir gönderiye yorum yapmak için post URL'sini kullanın.
                </p>
                <div style="margin-top: 15px;">
                    <input type="text" id="post-url-input" placeholder="LinkedIn post URL'sini buraya yapıştırın..." 
                           style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <textarea id="custom-comment-input" placeholder="İsteğe bağlı: Özel yorum metni (boş bırakırsanız AI oluşturur)" 
                              style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                    <button onclick="submitManualComment()" style="padding: 10px 20px; background: #0073b1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Yorum Gönder
                    </button>
                </div>
                <p id="manual-comment-status" style="margin-top: 10px;"></p>
            </section>

            <section id="auth-controls">
                <h2>Kimlik Doğrulama</h2>
                {% if is_logged_in %}
                    <p>LinkedIn hesabınızla başarıyla giriş yapıldı.</p>
                    <p><a href="/logout">Çıkış Yap</a></p>
                {% else %}
                    <p>Botun çalışabilmesi için LinkedIn hesabınızla oturum açmanız gerekmektedir.</p>
                    <a href="/login" class="button">LinkedIn ile Giriş Yap</a>
                {% endif %}
            </section>

            <section id="activity-feed">
                <h2>Eylem Akışı</h2>
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-item">
                        <p><strong>Tür:</strong> {{ log.action_type }}</p>
                        <p><strong>Detay:</strong> {{ log.details }}
                            {% if log.result_url %}
                                <a href="{{ log.result_url }}" target="_blank" class="verify-link">(Sonucu Gör)</a>
                            {% endif %}
                        </p>
                        <p><strong>Zaman:</strong> {{ log.timestamp | istanbul_time }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>Henüz gerçekleştirilmiş bir eylem bulunmuyor.</p>
                {% endif %}
            </section>
        </main>
    </div>

    <script>
        // Fetch and display scheduled jobs
        async function fetchScheduledJobs() {
            try {
                const response = await fetch('/api/scheduled-jobs');
                const jobs = await response.json();
                const jobsList = document.getElementById('jobs-list');
                jobsList.innerHTML = ''; // Clear current list

                if (jobs.length === 0) {
                    jobsList.innerHTML = '<li>Aktif planlanmış görev bulunmuyor.</li>';
                    return;
                }

                jobs.forEach(job => {
                    const listItem = document.createElement('li');
                    const nextRun = new Date(job.next_run_time).toLocaleString('tr-TR');
                    listItem.textContent = `Görev: ${job.id} - Sonraki Çalışma: ${nextRun}`;
                    jobsList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching scheduled jobs:', error);
                document.getElementById('jobs-list').innerHTML = '<li>Görevler yüklenirken bir hata oluştu.</li>';
            }
        }

        // Trigger a manual action
        async function triggerAction(endpoint, skipReload = false) {
            const statusElement = document.getElementById('manual-action-status');
            statusElement.innerHTML = '<p style="color: #1877f2;">İşlem başlatılıyor...</p>';

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    let html = `<div style="color: green; margin-top: 10px;">
                        <p><strong>✅ ${result.message}</strong></p>`;
                    
                    if (result.url) {
                        html += `<p>🔗 <a href="${result.url}" target="_blank" style="color: #0073b1; text-decoration: underline;">LinkedIn'de Görüntüle</a></p>`;
                    }
                    
                    if (result.actions && result.actions.length > 0) {
                        html += '<div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 3px solid #0073b1;">';
                        result.actions.forEach(action => {
                            html += `<p style="margin: 5px 0;">${action}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    statusElement.innerHTML = html;
                } else {
                    statusElement.innerHTML = `<p style="color: red;">❌ ${result.message || 'İşlem başarısız oldu.'}</p>`;
                }

                // Refresh the activity feed after a short delay, unless skipped
                if (!skipReload && result.success) {
                    setTimeout(() => location.reload(), 3000);
                }

            } catch (error) {
                console.error(`Error triggering action ${endpoint}:`, error);
                statusElement.innerHTML = '<p style="color: red;">❌ İşlem sırasında bir hata oluştu.</p>';
            }
        }

        // Submit manual comment
        async function submitManualComment() {
            const postUrl = document.getElementById('post-url-input').value.trim();
            const customComment = document.getElementById('custom-comment-input').value.trim();
            const statusElement = document.getElementById('manual-comment-status');

            if (!postUrl) {
                statusElement.innerHTML = '<p style="color: red;">❌ Lütfen LinkedIn post URL\'sini girin.</p>';
                return;
            }

            statusElement.innerHTML = '<p style="color: #1877f2;">Yorum gönderiliyor...</p>';

            try {
                const response = await fetch('/api/manual_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        post_url: postUrl,
                        comment: customComment
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let html = `<div style="color: green; margin-top: 10px;">
                        <p><strong>✅ ${result.message}</strong></p>`;
                    
                    if (result.url) {
                        html += `<p>🔗 <a href="${result.url}" target="_blank" style="color: #0073b1; text-decoration: underline;">LinkedIn'de Görüntüle</a></p>`;
                    }
                    
                    if (result.actions && result.actions.length > 0) {
                        html += '<div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 3px solid #0073b1;">';
                        result.actions.forEach(action => {
                            html += `<p style="margin: 5px 0;">${action}</p>`;
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    statusElement.innerHTML = html;

                    // Clear inputs
                    document.getElementById('post-url-input').value = '';
                    document.getElementById('custom-comment-input').value = '';

                    // Refresh the activity feed after a short delay
                    setTimeout(() => location.reload(), 3000);
                } else {
                    statusElement.innerHTML = `<p style="color: red;">❌ ${result.message || 'Yorum gönderilemedi.'}</p>`;
                }

            } catch (error) {
                console.error('Error submitting manual comment:', error);
                statusElement.innerHTML = '<p style="color: red;">❌ Yorum gönderilirken bir hata oluştu.</p>';
            }
        }

        // Initial fetch and periodic refresh
        document.addEventListener('DOMContentLoaded', () => {
            fetchScheduledJobs();
            setInterval(fetchScheduledJobs, 10000); // Refresh every 10 seconds
        });
    </script>
</body>
</html>
